{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Windows/Documents/AIGP/aigp/app/api/settings/route.ts"],"sourcesContent":["import { neon, neonConfig } from \"@neondatabase/serverless\";\r\n\r\nneonConfig.fetchConnectionCache = true;\r\n\r\nif (!process.env.POSTGRES_URL) {\r\n  throw new Error(\"Vari√°vel de ambiente POSTGRES_URL n√£o definida.\");\r\n}\r\n\r\nconst sql = neon(process.env.POSTGRES_URL);\r\n\r\n/* =========================================================\r\n   üìã Interface do modelo\r\n   ========================================================= */\r\nexport interface AiSettings {\r\n  id: string;\r\n  agent_name: string;\r\n  ai_model: string;\r\n  calendar_id: string | null;\r\n  focus_keywords: string | null;\r\n  remote_post_url: string | null;\r\n  remote_post_api_key: string | null;\r\n  json_format_template: string | null;\r\n  created_at: string;\r\n  updated_at: string;\r\n}\r\n\r\n/* =========================================================\r\n   üß± Cria√ß√£o da tabela\r\n   ========================================================= */\r\nexport async function setupSettingsTable() {\r\n  try {\r\n    await sql`\r\n      CREATE TABLE IF NOT EXISTS ai_settings (\r\n        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\r\n        agent_name TEXT NOT NULL DEFAULT 'Agente Tio Ben',\r\n        ai_model TEXT NOT NULL DEFAULT 'gemini-1.5-flash',\r\n        calendar_id TEXT,\r\n        focus_keywords TEXT,\r\n        remote_post_url TEXT,\r\n        remote_post_api_key TEXT,\r\n        json_format_template TEXT,\r\n        created_at TIMESTAMPTZ DEFAULT NOW(),\r\n        updated_at TIMESTAMPTZ DEFAULT NOW()\r\n      );\r\n    `;\r\n\r\n    // Se n√£o houver registros, cria um padr√£o\r\n    const result = await sql`SELECT COUNT(*) AS count FROM ai_settings;`;\r\n    const count = Number(result[0].count);\r\n\r\n    if (count === 0) {\r\n      await sql`\r\n        INSERT INTO ai_settings (\r\n          agent_name, ai_model, calendar_id, focus_keywords,\r\n          remote_post_url, remote_post_api_key, json_format_template\r\n        ) VALUES (\r\n          'Agente Tio Ben',\r\n          'gemini-1.5-flash',\r\n          'primary_calendar',\r\n          'liturgia di√°ria, santos, f√© cat√≥lica, espiritualidade',\r\n          'https://www.iatioben.com.br/api/remote-post',\r\n          'CHAVE_API_AQUI',\r\n          '{\"title\":\"...\", \"slug\":\"...\", \"content\":\"...\", \"metaDescription\":\"...\"}'\r\n        );\r\n      `;\r\n      console.log(\"‚úÖ Configura√ß√£o padr√£o criada na tabela ai_settings.\");\r\n    } else {\r\n      console.log(\"‚úÖ Tabela ai_settings j√° possui configura√ß√£o existente.\");\r\n    }\r\n  } catch (error) {\r\n    console.error(\"‚ùå Erro ao criar/verificar tabela ai_settings:\", error);\r\n    throw new Error(\"Falha ao configurar a tabela de configura√ß√µes da IA.\");\r\n  }\r\n}\r\n\r\n/* =========================================================\r\n   üîç Buscar configura√ß√µes atuais\r\n   ========================================================= */\r\nexport async function getSettings(): Promise<AiSettings | null> {\r\n  try {\r\n    const result = await sql`SELECT * FROM ai_settings ORDER BY created_at ASC LIMIT 1;`;\r\n    if (!result || result.length === 0) return null;\r\n\r\n    const row = result[0];\r\n    console.log(\"‚öôÔ∏è Configura√ß√µes carregadas:\", row.agent_name);\r\n    return row as AiSettings;\r\n  } catch (error) {\r\n    console.error(\"‚ùå Erro ao buscar configura√ß√µes:\", error);\r\n    throw new Error(\"Falha ao buscar configura√ß√µes da IA.\");\r\n  }\r\n}\r\n\r\n/* =========================================================\r\n   ‚úèÔ∏è Atualizar configura√ß√µes\r\n   ========================================================= */\r\nexport async function updateSettings(data: Partial<AiSettings>): Promise<void> {\r\n  try {\r\n    const result = await sql`SELECT id FROM ai_settings ORDER BY created_at ASC LIMIT 1;`;\r\n    if (!result || result.length === 0) throw new Error(\"Nenhuma configura√ß√£o encontrada.\");\r\n\r\n    const { id } = result[0];\r\n    const fields = Object.keys(data);\r\n    if (fields.length === 0) return;\r\n\r\n    const setClause = fields\r\n      .map((key, i) => `${key} = $${i + 1}`)\r\n      .join(\", \");\r\n    const values = Object.values(data);\r\n\r\n    const query = `\r\n      UPDATE ai_settings\r\n      SET ${setClause}, updated_at = NOW()\r\n      WHERE id = $${fields.length + 1};\r\n    `;\r\n\r\n    await sql(query, [...values, id]);\r\n    console.log(`‚úÖ Configura√ß√µes atualizadas: ${fields.join(\", \")}`);\r\n  } catch (error) {\r\n    console.error(\"‚ùå Erro ao atualizar configura√ß√µes:\", error);\r\n    throw new Error(\"Falha ao atualizar as configura√ß√µes da IA.\");\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAAA;;AAEA,sKAAU,CAAC,oBAAoB,GAAG;AAElC,IAAI,CAAC,QAAQ,GAAG,CAAC,YAAY,EAAE;IAC7B,MAAM,IAAI,MAAM;AAClB;AAEA,MAAM,MAAM,IAAA,gKAAI,EAAC,QAAQ,GAAG,CAAC,YAAY;AAqBlC,eAAe;IACpB,IAAI;QACF,MAAM,GAAG,CAAC;;;;;;;;;;;;;IAaV,CAAC;QAED,0CAA0C;QAC1C,MAAM,SAAS,MAAM,GAAG,CAAC,0CAA0C,CAAC;QACpE,MAAM,QAAQ,OAAO,MAAM,CAAC,EAAE,CAAC,KAAK;QAEpC,IAAI,UAAU,GAAG;YACf,MAAM,GAAG,CAAC;;;;;;;;;;;;;MAaV,CAAC;YACD,QAAQ,GAAG,CAAC;QACd,OAAO;YACL,QAAQ,GAAG,CAAC;QACd;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,iDAAiD;QAC/D,MAAM,IAAI,MAAM;IAClB;AACF;AAKO,eAAe;IACpB,IAAI;QACF,MAAM,SAAS,MAAM,GAAG,CAAC,0DAA0D,CAAC;QACpF,IAAI,CAAC,UAAU,OAAO,MAAM,KAAK,GAAG,OAAO;QAE3C,MAAM,MAAM,MAAM,CAAC,EAAE;QACrB,QAAQ,GAAG,CAAC,gCAAgC,IAAI,UAAU;QAC1D,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,mCAAmC;QACjD,MAAM,IAAI,MAAM;IAClB;AACF;AAKO,eAAe,eAAe,IAAyB;IAC5D,IAAI;QACF,MAAM,SAAS,MAAM,GAAG,CAAC,2DAA2D,CAAC;QACrF,IAAI,CAAC,UAAU,OAAO,MAAM,KAAK,GAAG,MAAM,IAAI,MAAM;QAEpD,MAAM,EAAE,EAAE,EAAE,GAAG,MAAM,CAAC,EAAE;QACxB,MAAM,SAAS,OAAO,IAAI,CAAC;QAC3B,IAAI,OAAO,MAAM,KAAK,GAAG;QAEzB,MAAM,YAAY,OACf,GAAG,CAAC,CAAC,KAAK,IAAM,GAAG,IAAI,IAAI,EAAE,IAAI,GAAG,EACpC,IAAI,CAAC;QACR,MAAM,SAAS,OAAO,MAAM,CAAC;QAE7B,MAAM,QAAQ,CAAC;;UAET,EAAE,UAAU;kBACJ,EAAE,OAAO,MAAM,GAAG,EAAE;IAClC,CAAC;QAED,MAAM,IAAI,OAAO;eAAI;YAAQ;SAAG;QAChC,QAAQ,GAAG,CAAC,CAAC,6BAA6B,EAAE,OAAO,IAAI,CAAC,OAAO;IACjE,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,sCAAsC;QACpD,MAAM,IAAI,MAAM;IAClB;AACF","debugId":null}}]
}